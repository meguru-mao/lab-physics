# 接口文档（登录与实验绘图）

后端基础地址：

- 开发环境（默认）：`http://localhost:8000`
- 静态资源（图片预览）：`http://localhost:8000/static/...`

所有生成图像的接口均需要在请求头携带登录获得的 `Authorization: Bearer <token>`。

## 1. 健康检查

- 方法：GET `/api/ping`
- 响应：`{"message":"pong"}`

## 2. 微信登录（模拟可用）

- 方法：POST `/api/auth/wechat`
- 请求体：

```json
{ "code": "<wx.login 获取的 code，开发环境可传 DEV_CODE>" }
```

- 响应：

```json
{
  "token": "<JWT Token>",
  "user": { "user_id": 1, "openid": "mock_DEV_CODE", "role": "normal", "created_at": "2024-01-01T00:00:00" }
}
```

> 说明：开发环境或未配置 `WECHAT_APPID/WECHAT_APP_SECRET` 时会返回 mock openid，便于联调。

## 3. 光纤传感与通讯绘图

- 方法：POST `/api/plots/fiber`
- 请求头：`Authorization: Bearer <token>`
- 请求体（三选一）：

1) I-U 图
```json
{
  "plot_type": "iu",
  "U": [0, 0.75, 1.0, 1.1],
  "I": [0, 0.2, 5, 10]
}
```

2) P-I 图
```json
{
  "plot_type": "pi",
  "I": [0, 5, 10, 15],
  "P": [0, 0.001, 0.167, 0.411]
}
```

3) 光电二极管 I-V 图
```json
{
  "plot_type": "photodiode",
  "V": [0, 1, 2, 3, 4, 5],
  "I0": [0, 0, 0, 0, 0, 0],
  "I1": [98, 99, 99, 100, 98, 99],
  "I2": [200, 200, 199, 200, 200, 200]
}
```

- 响应：

```json
{ "images": ["/static/plots/<user_id>/fiber/<file>.png"], "message": "生成完成" }
```

## 4. 弗兰克-赫兹绘图

- 方法：POST `/api/plots/frank-hertz`
- 请求头：`Authorization: Bearer <token>`
- 请求体：

```json
{
  "VG2K": [1.0, 2.0, 3.0],
  "groups": [
    { "currents": [0.0, 0.014, 0.045], "label": "VG1=2.3V, VG2A=1.5V, VG2P=9V" },
    { "currents": [0.0, 0.010, 0.043], "label": "VG1=2.5V, VG2A=1.5V, VG2P=9V" }
  ]
}
```

> 说明：请求体中的 `VG2K` 可省略，后端将默认使用 1..82（浮点）作为 x 轴；此时每组 `currents` 需提供 82 项。

> 拟合方法：弗兰克-赫兹曲线使用 SciPy 的 `CubicSpline` 进行三次样条拟合，生成的图像与项目示例代码一致。

- 响应：

```json
{ "images": ["/static/plots/<user_id>/frank-hertz/<file1>.png", 
              "/static/plots/<user_id>/frank-hertz/<file2>.png"],
  "message": "共生成2张图像" }
```

> 说明：本实现使用多项式拟合近似样条平滑，无 SciPy 依赖，适合快速部署。

## 5. 密立根油滴绘图

- 方法：POST `/api/plots/millikan`
- 请求头：`Authorization: Bearer <token>`
- 请求体：

```json
{ "ni": [2, 2, 5, 6], "qi": [3.214, 3.191, 8.167, 9.302] }
```

- 响应：

```json
{ "images": ["/static/plots/<user_id>/millikan/<file>.png"], "message": "生成完成" }
```

## 6. 力学实验绘图（T²-M 与 v²-x²）

- 方法：POST `/api/plots/mechanics`
- 请求头：`Authorization: Bearer <token>`
- 请求体：

```json
{
  "t2m": {
    "m0_g": 241.68,
    "weights_g": [20, 40, 50, 70, 100],
    "T10_avg_s": [17.0158, 17.6387, 17.9340, 18.5316, 19.3818]
  },
  "v2x2": {
    "x_cm": [0, 4, 6, 8, 10, 12, 14, 16, 18],
    "v_avg_cms": [77.34, 72.47, 71.17, 69.17, 63.92, 57.30, 49.67, 41.67, 29.70]
  }
}
```

- 响应：

```json
{ "images": ["/static/plots/<user_id>/mechanics/<t2m_file>.png", 
              "/static/plots/<user_id>/mechanics/<v2x2_file>.png"],
  "message": "生成完成" }
```

## 7. 热学综合实验绘图（Pt100 与 NTC）

- 方法：POST `/api/plots/thermal`
- 请求头：`Authorization: Bearer <token>`
- 请求体：

```json
{
  "temperatures": [55, 60, 65, 70, 75, 80],
  "pt100_resistance": [126.56, 128.55, 130.71, 132.85, 134.97, 137.09],
  "ntc_resistance": [2883, 2424, 2027, 1701, 1435, 1217]
}
```

- 响应：

```json
{ "images": [
    "/static/plots/<user_id>/thermal/Pt100_电阻温度变化_<file>.png",
    "/static/plots/<user_id>/thermal/NTC_电阻温度变化_<file>.png"
  ],
  "message": "共生成2张图像" }
```

## 8. 光电器件性能绘图（10个子图合并）

- 方法：POST `/api/plots/photo-devices`
- 请求头：`Authorization: Bearer <token>`
- 请求体（字段较多，示例）：

```json
{
  "led_I": [0.4, 5, 10, 15, 20, 25, 30],
  "led_V": [0.13, 0.88, 0.92, 0.92, 0.97, 1.00, 1.02],
  "led_P": [0.1, 1.669, 2.899, 3.931, 4.846, 5.659, 6.385],
  "ld_I": [0.5, 3, 6, 9, 12, 15, 18, 21],
  "ld_V": [0.14, 0.92, 0.97, 1.00, 1.03, 1.07, 1.10, 1.13],
  "ld_P": [0.0001, 0.06793, 0.246, 17.4, 68.53, 121.2, 172.6, 224.8],
  "ld_linear_start_idx": 4,
  "pd_L": [50, 100, 150, 200, 250, 300],
  "pd_I_L": [1.6, 2.8, 4.0, 5.3, 6.5, 7.7],
  "pd_V": [0, 2, 4, 6, 8],
  "pd_I_V": [4.8, 5.0, 5.2, 5.4, 5.6],
  "pd_wl": [650, 610, 570, 530, 450, 400, 550],
  "pd_I_wl": [0, 0, 0, 1.4, 1.3, 2.4, 1.6],
  "pt_L": [50, 100, 150, 200, 250, 300],
  "pt_I_L": [0.24, 0.58, 0.93, 1.29, 1.66, 2.03],
  "pt_V": [2, 4, 6, 8, 10],
  "pt_I_V": [1.21, 1.27, 1.32, 1.37, 1.41],
  "pt_wl": [650, 610, 570, 530, 450, 400, 550],
  "pt_I_wl": [0, 0, 0, 0.03, 0.02, 0.02, 0.13]
}
```

- 响应：

```json
{ "images": ["/static/plots/<user_id>/photo-devices/光电器件性能曲线_<file>.png"], "message": "生成完成" }
```

## 9. 太阳能电池特性绘图（6张图）

- 方法：POST `/api/plots/solar-cell`
- 请求头：`Authorization: Bearer <token>`
- 请求体：

```json
{
  "dark_voltage": [2.86, 2.67, 2.48, 2.29, 2.10, 1.91, 1.72, 1.53, 1.34, 1.15, 0.96, 0.77, 0.58, 0.39],
  "dark_current": [0.135, 0.109, 0.087, 0.069, 0.055, 0.043, 0.033, 0.025, 0.019, 0.014, 0.010, 0.006, 0.004, 0.002],
  "light_voltage": [0.92, 1.82, 2.70, 3.50, 4.13, 4.47, 4.66, 4.78, 4.86, 4.91, 4.96, 4.99, 5.01, 5.03, 5.05, 5.07, 5.08, 5.09, 5.10, 5.10],
  "light_current": [17.5, 17.4, 17.3, 16.9, 15.9, 14.5, 12.9, 11.7, 10.5, 9.5, 8.8, 8.0, 7.5, 7.1, 6.6, 6.2, 5.8, 5.6, 5.2, 5.0],
  "relative_intensity": [1, 0.853, 0.729, 0.622, 0.556, 0.511, 0.480, 0.448, 0.422, 0.396],
  "light_power": [0.225, 0.192, 0.164, 0.140, 0.125, 0.115, 0.108, 0.101, 0.095, 0.089],
  "short_circuit_current": [16.2, 14.1, 12.1, 10.4, 9.0, 8.1, 7.3, 6.6, 5.9, 5.4],
  "open_circuit_voltage": [5.63, 5.55, 5.48, 5.41, 5.35, 5.29, 5.24, 5.19, 5.15, 5.11]
}
```

- 响应：

```json
{ "images": [
  "/static/plots/<user_id>/solar-cell/图1_全暗伏安_<file>.png",
  "/static/plots/<user_id>/solar-cell/图2_光照伏安_<file>.png",
  "/static/plots/<user_id>/solar-cell/图3_短路电流相对光强_<file>.png",
  "/static/plots/<user_id>/solar-cell/图4_开路电压相对光强_<file>.png",
  "/static/plots/<user_id>/solar-cell/图5_短路电流光功率_<file>.png",
  "/static/plots/<user_id>/solar-cell/图6_开路电压光功率_<file>.png"
], "message": "共生成6张图像" }
```

## 10. 超声波实验绘图（5张图：自由落体+三组匀变速+牛顿第二定律）

- 方法：POST `/api/plots/ultrasound`
- 请求头：`Authorization: Bearer <token>`
- 请求体（示例，字段对应双方约定）：

```json
{
  "t_free_fall": [0.05, 0.10, 0.15, 0.20, 0.25, 0.30, 0.35, 0.40],
  "v_free_fall_1": [0.65, 1.13, 1.63, 2.10, 2.64, 3.10, 3.55, 4.01],
  "v_free_fall_2": [0.63, 1.13, 1.64, 2.14, 2.57, 2.80, 3.69, 3.96],
  "v_free_fall_3": [0.66, 1.14, 1.64, 2.11, 2.61, 3.07, 3.56, 3.95],
  "v_free_fall_4": [0.67, 1.14, 1.65, 2.12, 2.60, 3.09, 3.56, 3.96],
  "t1": [0.01, 0.02, 0.03, 0.04, 0.05, 0.06, 0.07, 0.08, 0.09, 0.10, 0.11, 0.12, 0.13],
  "v1_1": [0.20, 0.25, 0.31, 0.36, 0.39, 0.45, 0.50, 0.54, 0.59, 0.66, 0.73, 0.78, 0.83],
  "v1_2": [0.19, 0.25, 0.30, 0.36, 0.40, 0.46, 0.51, 0.55, 0.60, 0.65, 0.72, 0.75, 0.82],
  "v1_3": [0.20, 0.26, 0.30, 0.35, 0.40, 0.45, 0.51, 0.55, 0.60, 0.65, 0.72, 0.75, 0.81],
  "v1_4": [0.20, 0.25, 0.30, 0.35, 0.40, 0.45, 0.51, 0.56, 0.61, 0.67, 0.73, 0.77, 0.80],
  "t2": [0.04, 0.08, 0.12, 0.16, 0.20, 0.24, 0.28, 0.32, 0.36, 0.40, 0.44, 0.48, 0.52],
  "v2_1": [0.28, 0.45, 0.63, 0.80, 0.95, 1.16, 1.34, 1.53, 1.67, 1.87, 2.04, 2.22, 2.40],
  "v2_2": [0.28, 0.44, 0.64, 0.79, 0.98, 1.17, 1.34, 1.51, 1.73, 1.86, 2.05, 2.21, 2.42],
  "v2_3": [0.28, 0.37, 0.65, 0.78, 0.99, 1.18, 1.34, 1.51, 1.72, 1.86, 2.04, 2.21, 2.41],
  "v2_4": [0.28, 0.43, 0.60, 0.79, 0.98, 1.18, 1.34, 1.52, 1.72, 1.86, 2.04, 2.21, 2.41],
  "t3": [0.03, 0.06, 0.09, 0.12, 0.15, 0.18, 0.21, 0.24, 0.27, 0.30, 0.33, 0.36, 0.39],
  "v3_1": [0.17, 0.28, 0.37, 0.44, 0.56, 0.65, 0.74, 0.84, 0.95, 1.04, 1.14, 1.23, 1.36],
  "v3_2": [0.17, 0.31, 0.38, 0.45, 0.55, 0.66, 0.73, 0.84, 0.96, 1.05, 1.15, 1.24, 1.39],
  "v3_3": [0.17, 0.30, 0.36, 0.45, 0.55, 0.65, 0.74, 0.85, 0.96, 1.07, 1.18, 1.30, 1.39],
  "v3_4": [0.16, 0.30, 0.36, 0.45, 0.55, 0.65, 0.74, 0.84, 0.95, 1.07, 1.16, 1.30, 1.41],
  "m": [0.01999, 0.03219, 0.440],
  "a_measured": [5.4374, 4.3351, 3.3228]
}
```

- 响应：

```json
{ "images": [
  "/static/plots/<user_id>/ultrasound/自由落体运动拟合图_<file>.png",
  "/static/plots/<user_id>/ultrasound/匀变速第1组拟合图_<file>.png",
  "/static/plots/<user_id>/ultrasound/匀变速第2组拟合图_<file>.png",
  "/static/plots/<user_id>/ultrasound/匀变速第3组拟合图_<file>.png",
  "/static/plots/<user_id>/ultrasound/牛顿第二定律验证图_<file>.png"
], "message": "共生成5张图像" }
```

---

### 统一错误响应格式

当请求参数缺失或校验失败时，返回：

```json
{ "detail": "错误原因说明" }
```

### 预览与下载

- 预览：前端直接使用 `<image src="http://localhost:8000/static/..." />` 或 H5 `<img />` 标签显示即可。
- 下载：
  - H5：使用 `<a href="..." download="...">` 或通过 `fetch + blob` 触发保存；
  - 微信小程序：`uni.downloadFile` + `wx.saveImageToPhotosAlbum` 保存到相册（需申请权限）。